<html>
<head>
    <style>

        body {
            background-color: #3f3f3f;
            margin: 0;
            padding: 0;
        }

        #viewerContainer {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        #content-parent {
            margin: 0 auto;

        }


        iframe {
            display: block;
        }

        /*body {*/

            /*-ms-zoom: 1.75;*/
            /*-moz-transform: scale(1.75);*/
            /*-o-transform: scale(1.75);*/
            /*-webkit-transform: scale(1.75);*/

            /*-moz-transform-origin: 0 0;*/
            /*-o-transform-origin: 0 0;*/
            /*-webkit-transform-origin: 0 0;*/
        /*}*/

    </style>


    <link rel="stylesheet" href="../node_modules/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../node_modules/jquery-contextmenu/dist/jquery.contextMenu.min.css">

    <link rel="stylesheet" href="../pdfviewer-custom/polar.css">

    <!--<link rel="stylesheet" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">-->
    <!--<link rel="stylesheet" href="../../web/css/bootswatch-slate.min.css">-->

    <meta name="polar-doc-format" content="html">

    <meta name="polar-fingerprint" content="htmldoc01">

    <script src="../web/dist/injector-bundle.js" ></script>

</head>

<body>

<div id="polar-header">
    <progress id="pagemark-progress" value="0.0"></progress>
</div>

<div id="viewerContainer">
    <div id="content-parent" class="page" data-page-number="1" style="width: 768px;">
        <!--<div id="click-layer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: orange; opacity: 0.5;">-->

        <!-- FIXME: this overlap layer DOES work to find the click position but
            it means that I can't click on the links and that the document is
            not usable -->

        <!--<div class="overlap-layer" style="position: absolute; left: 113px; top: 45px; width: 768px; height: 19034px; z-index: -1;"></div>-->
        <div class="textLayer iframeWrapper">
            <iframe src="example1.html" style="width: 768px; height: 100%;" frameborder="0" id="content"></iframe>
        </div>
        <!--</div>-->
    </div>
</div>

<div id="polar-footer">
    <div id="polar-doc-overview"></div>
</div>

<script>

    /**
     * Moves events from the iframe, into the target document. This allows the event
     * listeners to see the event as if it was called inside the parent .page
     * in the parent DOM window.
     */
    class EventBridge {

        constructor(textLayer, iframe) {
            this.textLayer = textLayer;
            this.iframe = iframe;
        }

        start() {

            this.iframe.contentDocument.body.addEventListener("keyup", this.eventListener.bind(this));
            this.iframe.contentDocument.body.addEventListener("keydown", this.eventListener.bind(this));
            this.iframe.contentDocument.body.addEventListener("click", this.eventListener.bind(this));

            console.log("Event bridge started on: ", this.iframe);

        }

        eventListener(event) {
            console.log("GOT bridge event", event);
            let newEvent = new event.constructor(event.type, event)

            this.textLayer.dispatchEvent(newEvent);
        }

    }

    /**
     * Listens for the iframe to load and then sends the events so that the
     * controllers can see.
     */
    class FrameInitializer {

        constructor(iframe, textLayer) {

            if(!iframe) {
                throw new Error("No iframe");
            }

            this.iframe = iframe;
            this.textLayer = textLayer;

        }

        start() {

            this.iframe.addEventListener("load", this.onLoad.bind(this));

        }

        /**
         *
         */
        onLoad() {

            console.log("Frame loaded.  Sending pagesinit on .page");
            this.dispatchPagesInit();
            this.startEventBridge();
        }

        dispatchPagesInit() {

            let event = new Event('pagesinit', {bubbles: true});

            // Dispatch the event.
            document.querySelector(".page").dispatchEvent(event);

        }

        startEventBridge() {
            let eventBridge = new EventBridge(this.textLayer, this.iframe);
            eventBridge.start();
        }

    }

    /**
     * Frame loader which polls the content iframe until it's loaded.  There's
     * really no way to get loading 'progress' so the trick is to just poll
     * fast enough to get the document size so that the user never notices.
     */
    class FrameResizer {

        constructor(parent, iframe) {

            if(!parent) {
                throw new Error("No parent");
            }

            if(!iframe) {
                throw new Error("No iframe");
            }

            this.parent = parent;
            this.iframe = iframe;

            this.completed = false;

            // how long between polling should we wait to expand the size.
            this.timeoutInterval = 125;

        }

        start() {
            this.iframe.addEventListener("load", this.onLoad.bind(this));
            this.resizeParent();
        }

        /**
         *
         */
        onLoad() {
            console.log("Document has finished loading");
            // call once more.
            this.resizeParent();
            this.completed = true;
        }

        resizeParent() {

            if(this.completed) {
                console.log("Frame finished loading");
                return;
            }

            if(! this.iframe.contentDocument) {
                console.log("contentDocument not ready yet.");
                return;
            }

            let newHeight = this.iframe.contentDocument.documentElement.scrollHeight;
            console.log("Setting new height to: " + newHeight);
            this.parent.style.height = newHeight;

            setTimeout(this.resizeParent.bind(this), this.timeoutInterval);

        }

    }

    // FIXME: take the URL via a file URL in the URL then cause the iframe to
    // load.

    let content = document.querySelector("#content");
    let contentParent = document.querySelector("#content-parent");
    let textLayer = document.querySelector(".textLayer");


    let frameResizer = new FrameResizer(contentParent,
                                        content);
    frameResizer.start();

    let frameInitializer = new FrameInitializer(content, textLayer);
    frameInitializer.start();

</script>

</body>
</html>
