<html>

<script>

const {assertJSON} = require("../../web/js/test/Assertions");
const {Ranges} = require("../../web/js/highlights/text/selection/Ranges.js");
const {Selections} = require("../../web/js/highlights/text/selection/Selections.js");
const {RectTexts} = require("../../web/js/highlights/text/controller/RectTexts.js");
const {SimpleHighlightRenderer} = require("../../web/js/highlights/text/view/SimpleHighlightRenderer.js");
const {NodeTypes} = require("../../web/js/highlights/text/selection/NodeTypes");

</script>

<body>

    <h1 id="n1">
        This is a heading
    </h1>

    <p id="n2">
        This is a body <em id="n3">with</em> so <b class="s1" id="n4">interesting</b> text.
    </p>

    <p class="s1" id="n5">
        Paragraph two starts <i class="s1" id="n6">here</i>.
    </p>

    <p class="s1" id="n7">
        this is just raw text without any inner elements.
        this is just raw text without any inner elements.
        this is just raw text without any inner elements.
        this is just raw text without any inner elements.
    </p>

    <script>

        class NodeOffset {

            /**
             *
             * @param obj
             */
            constructor(obj) {

                /**
                 * The DOM node where this
                 * @type {Node}
                 */
                this.node = null;

                /**
                 *
                 * The offset in this node where the selection begin/ends.
                 *
                 * @type {number}
                 */
                this.offset = null;

                Object.assign(this, obj);

            }

        }

        /**
         *
         * @param start {NodeOffset | Object}
         * @param end {NodeOffset | Object}
         */
        function createSyntheticSelection(start, end) {

            let selection = window.getSelection();

            selection.empty();

            let range = document.createRange();

            range.setStart(start.node, start.offset);

            console.log("end.node type is: " + NodeTypes.toSymbol(end.node.nodeType))

            range.setEnd(end.node, end.offset);

            selection.addRange(range);

            return selection;

        }

        function createSyntheticSelection1() {

            // FIXME why does the offset need to be 30?
            return createSyntheticSelection({ node: document.querySelector("#n4"), offset: 0},
                                            { node: document.querySelector("#n7").firstChild, offset: 35});

        }

        let expected;

        let selection = createSyntheticSelection1();

        console.log("selection: ", selection);

        let selectedContent = Selections.computeSelectionRects(window);

        let ranges = Selections.toRanges(selection);
        console.log("FIXME1", ranges);
        ranges = Ranges.cloneRanges(ranges)
        console.log("FIXME2", ranges);

        let textNodes = Ranges.getTextNodes(ranges[0]);

        console.log("textNodes: ", textNodes)

        let rectTexts = RectTexts.toRectTexts(textNodes);

        expected = [
            {
                "clientRects": {
                    "0": {
                        "x": 188.234375,
                        "y": 67.4375,
                        "width": 99.1875,
                        "height": 19,
                        "top": 67.4375,
                        "right": 287.421875,
                        "bottom": 86.4375,
                        "left": 188.234375
                    }
                },
                "boundingClientRect": {
                    "x": 188.234375,
                    "y": 67.4375,
                    "width": 99.1875,
                    "height": 19,
                    "top": 67.4375,
                    "right": 287.421875,
                    "bottom": 86.4375,
                    "left": 188.234375
                },
                "text": "interesting",
                "boundingPageRect": {
                    "left": 188.234375,
                    "top": 67.4375,
                    "right": 287.421875,
                    "bottom": 86.4375,
                    "width": 99.1875,
                    "height": 19,
                    "x": 188.234375,
                    "y": 67.4375
                }
            },
            {
                "clientRects": {
                    "0": {
                        "x": 287.421875,
                        "y": 67.4375,
                        "width": 41.515625,
                        "height": 19,
                        "top": 67.4375,
                        "right": 328.9375,
                        "bottom": 86.4375,
                        "left": 287.421875
                    }
                },
                "boundingClientRect": {
                    "x": 287.421875,
                    "y": 67.4375,
                    "width": 41.515625,
                    "height": 19,
                    "top": 67.4375,
                    "right": 328.9375,
                    "bottom": 86.4375,
                    "left": 287.421875
                },
                "text": " text.\n    ",
                "boundingPageRect": {
                    "left": 287.421875,
                    "top": 67.4375,
                    "right": 328.9375,
                    "bottom": 86.4375,
                    "width": 41.515625,
                    "height": 19,
                    "x": 287.421875,
                    "y": 67.4375
                }
            },
            {
                "clientRects": {},
                "boundingClientRect": {
                    "x": 0,
                    "y": 0,
                    "width": 0,
                    "height": 0,
                    "top": 0,
                    "right": 0,
                    "bottom": 0,
                    "left": 0
                },
                "text": "\n\n    ",
                "boundingPageRect": {
                    "left": 0,
                    "top": 0,
                    "right": 0,
                    "bottom": 0,
                    "width": 0,
                    "height": 0,
                    "x": 0,
                    "y": 0
                }
            },
            {
                "clientRects": {
                    "0": {
                        "x": 8,
                        "y": 102.4375,
                        "width": 176.234375,
                        "height": 19,
                        "top": 102.4375,
                        "right": 184.234375,
                        "bottom": 121.4375,
                        "left": 8
                    }
                },
                "boundingClientRect": {
                    "x": 8,
                    "y": 102.4375,
                    "width": 176.234375,
                    "height": 19,
                    "top": 102.4375,
                    "right": 184.234375,
                    "bottom": 121.4375,
                    "left": 8
                },
                "text": "\n        Paragraph two starts ",
                "boundingPageRect": {
                    "left": 8,
                    "top": 102.4375,
                    "right": 184.234375,
                    "bottom": 121.4375,
                    "width": 176.234375,
                    "height": 19,
                    "x": 8,
                    "y": 102.4375
                }
            },
            {
                "clientRects": {
                    "0": {
                        "x": 184.234375,
                        "y": 102.4375,
                        "width": 36.890625,
                        "height": 19,
                        "top": 102.4375,
                        "right": 221.125,
                        "bottom": 121.4375,
                        "left": 184.234375
                    }
                },
                "boundingClientRect": {
                    "x": 184.234375,
                    "y": 102.4375,
                    "width": 36.890625,
                    "height": 19,
                    "top": 102.4375,
                    "right": 221.125,
                    "bottom": 121.4375,
                    "left": 184.234375
                },
                "text": "here",
                "boundingPageRect": {
                    "left": 184.234375,
                    "top": 102.4375,
                    "right": 221.125,
                    "bottom": 121.4375,
                    "width": 36.890625,
                    "height": 19,
                    "x": 184.234375,
                    "y": 102.4375
                }
            },
            {
                "clientRects": {
                    "0": {
                        "x": 221.125,
                        "y": 102.4375,
                        "width": 5.078125,
                        "height": 19,
                        "top": 102.4375,
                        "right": 226.203125,
                        "bottom": 121.4375,
                        "left": 221.125
                    }
                },
                "boundingClientRect": {
                    "x": 221.125,
                    "y": 102.4375,
                    "width": 5.078125,
                    "height": 19,
                    "top": 102.4375,
                    "right": 226.203125,
                    "bottom": 121.4375,
                    "left": 221.125
                },
                "text": ".\n    ",
                "boundingPageRect": {
                    "left": 221.125,
                    "top": 102.4375,
                    "right": 226.203125,
                    "bottom": 121.4375,
                    "width": 5.078125,
                    "height": 19,
                    "x": 221.125,
                    "y": 102.4375
                }
            },
            {
                "clientRects": {},
                "boundingClientRect": {
                    "x": 0,
                    "y": 0,
                    "width": 0,
                    "height": 0,
                    "top": 0,
                    "right": 0,
                    "bottom": 0,
                    "left": 0
                },
                "text": "\n\n    ",
                "boundingPageRect": {
                    "left": 0,
                    "top": 0,
                    "right": 0,
                    "bottom": 0,
                    "width": 0,
                    "height": 0,
                    "x": 0,
                    "y": 0
                }
            },
            {
                "clientRects": {
                    "0": {
                        "x": 8,
                        "y": 137.4375,
                        "width": 196.5,
                        "height": 19,
                        "top": 137.4375,
                        "right": 204.5,
                        "bottom": 156.4375,
                        "left": 8
                    }
                },
                "boundingClientRect": {
                    "x": 8,
                    "y": 137.4375,
                    "width": 196.5,
                    "height": 19,
                    "top": 137.4375,
                    "right": 204.5,
                    "bottom": 156.4375,
                    "left": 8
                },
                "text": "\n        this is just raw text with",
                "boundingPageRect": {
                    "left": 8,
                    "top": 137.4375,
                    "right": 204.5,
                    "bottom": 156.4375,
                    "width": 196.5,
                    "height": 19,
                    "x": 8,
                    "y": 137.4375
                }
            }
        ]

        assertJSON(rectTexts, expected);

        console.log("rectTexts: ", rectTexts)

        expected = {
            "text": "interesting text.\n\nParagraph two starts here.\n\nthis is just raw text with",
            "rectTexts": [
                {
                    "rect": {
                        "left": 188.234375,
                        "top": 67.4375,
                        "right": 287.421875,
                        "bottom": 86.4375,
                        "width": 99.1875,
                        "height": 19,
                        "x": 188.234375,
                        "y": 67.4375
                    }
                },
                {
                    "rect": {
                        "left": 287.421875,
                        "top": 67.4375,
                        "right": 328.9375,
                        "bottom": 86.4375,
                        "width": 41.515625,
                        "height": 19,
                        "x": 287.421875,
                        "y": 67.4375
                    }
                },
                {
                    "rect": {
                        "left": 8,
                        "top": 102.4375,
                        "right": 755,
                        "bottom": 121.4375,
                        "width": 747,
                        "height": 19,
                        "x": 8,
                        "y": 102.4375
                    }
                },
                {
                    "rect": {
                        "left": 8,
                        "top": 102.4375,
                        "right": 184.234375,
                        "bottom": 121.4375,
                        "width": 176.234375,
                        "height": 19,
                        "x": 8,
                        "y": 102.4375
                    }
                },
                {
                    "rect": {
                        "left": 184.234375,
                        "top": 102.4375,
                        "right": 221.125,
                        "bottom": 121.4375,
                        "width": 36.890625,
                        "height": 19,
                        "x": 184.234375,
                        "y": 102.4375
                    }
                },
                {
                    "rect": {
                        "left": 221.125,
                        "top": 102.4375,
                        "right": 226.203125,
                        "bottom": 121.4375,
                        "width": 5.078125,
                        "height": 19,
                        "x": 221.125,
                        "y": 102.4375
                    }
                },
                {
                    "rect": {
                        "left": 8,
                        "top": 137.4375,
                        "right": 205,
                        "bottom": 156.4375,
                        "width": 197,
                        "height": 19,
                        "x": 8,
                        "y": 137.4375
                    }
                }
            ]
        };

        assertJSON(selectedContent, expected);

    </script>

        <!--selection.removeAllRanges();-->


        <!--console.log("done with range.");-->

        <!--// FIXME: one bug here is that we have one rect that encompasses the-->
        <!--// entire thing.  this is a big problem.-->

        <!--// FIXME: we need to figure out which one is the-->

        <!--//selectedContent.rectTexts.pop();-->

        <!--//selectedContent.rectTexts = selectedContent.rectTexts.splice(0,1);-->

        <!--selectedContent.rectTexts.forEach(rectText => {-->
            <!--console.log(rectText.rect);-->
            <!--SimpleHighlightRenderer.render(document.body, rectText.rect);-->
        <!--});-->

        <!--// TODO: we only want to put the highlight over TEXT nodes.. which we can-->
        <!--// get the client rects for.. not entire elements...-->

        <!--// https://superdevelopment.com/2016/02/08/working-with-the-html-selection-api/-->
        <!--// https://developer.mozilla.org/en-US/docs/Web/API/TreeWalker-->


    <!--</script>-->

</body>
</html>
